<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= novel ? 'Edit' : 'Add' %> Novel - Admin - CommissionDB</title>
    <link rel="stylesheet" href="/public/css/style.css">
    <link rel="stylesheet" href="/public/css/admin.css">
</head>
<body class="dark-theme">
    <nav class="admin-navbar">
        <div class="admin-navbar-container">
            <div class="admin-navbar-brand">
                <a href="/admin">CommissionDB Admin</a>
            </div>
            
            <div class="admin-navbar-menu">
                <a href="/admin" class="admin-navbar-item">Dashboard</a>
                <a href="/admin/commissions" class="admin-navbar-item">Commissions</a>
                <a href="/admin/novels" class="admin-navbar-item active">Novels</a>
                <a href="/admin/characters" class="admin-navbar-item">Characters</a>
                <a href="/admin/upper-campus" class="admin-navbar-item">Upper Campus</a>
                <a href="/admin/artists" class="admin-navbar-item">Artists</a>
                <a href="/admin/tags" class="admin-navbar-item">Tags</a>
                <a href="/admin/collections" class="admin-navbar-item">Collections</a>
            </div>

            <div class="admin-navbar-end">
                <div class="admin-navbar-item">
                    <span>Welcome, <%= user.username %></span>
                </div>
                <div class="admin-navbar-item">
                    <a href="/" class="btn btn-ghost">View Site</a>
                </div>
                <div class="admin-navbar-item">
                    <form method="POST" action="/admin/logout" style="display: inline;">
                        <button type="submit" class="btn btn-ghost">Logout</button>
                    </form>
                </div>
            </div>
        </div>
    </nav>

    <main class="admin-main">
        <div class="admin-container">
            <div class="admin-header">
                <h1><%= novel ? 'Edit' : 'Add' %> Novel</h1>
                <div class="admin-header-actions">
                    <a href="/admin/novels" class="btn btn-ghost">‚Üê Back to Novels</a>
                </div>
            </div>

            <div class="admin-content">
                <% if (error) { %>
                    <div class="alert alert-error">
                        <%= error %>
                    </div>
                <% } %>

                <% 
                // Helper function to get field value
                function getFieldValue(field) {
                    if (novel) {
                        return novel[field] || '';
                    } else if (typeof formData !== 'undefined' && formData) {
                        return formData[field] || '';
                    }
                    return '';
                }
                %>

                <form method="POST" action="<%= novel ? `/admin/novels/${novel.id}/edit` : '/admin/novels' %>" class="novel-form">
                    <div class="form-grid">
                        <!-- Basic Information -->
                        <div class="form-section">
                            <h3>Basic Information</h3>
                            
                            <div class="form-group">
                                <label for="title">Title *</label>
                                <input type="text" id="title" name="title" value="<%= getFieldValue('title') %>" required>
                            </div>

                            <div class="form-group">
                                <label for="description">Description</label>
                                <textarea id="description" name="description" rows="3"><%= getFieldValue('description') %></textarea>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="date_month">Date (YYYY-MM) *</label>
                                    <input type="text" id="date_month" name="date_month" value="<%= getFieldValue('date_month') %>" placeholder="2024-01" pattern="\d{4}-\d{2}" required>
                                </div>

                                <div class="form-group">
                                    <label for="price">Price</label>
                                    <input type="number" id="price" name="price" value="<%= getFieldValue('price') %>" step="0.01" min="0">
                                </div>

                                <div class="form-group">
                                    <label for="score">Score</label>
                                    <input type="number" id="score" name="score" value="<%= getFieldValue('score') || 100 %>" min="0" max="100">
                                </div>

                                <div class="form-group">
                                    <label for="status">Status</label>
                                    <select id="status" name="status">
                                        <option value="draft" <%= getFieldValue('status') === 'draft' ? 'selected' : '' %>>Draft</option>
                                        <option value="published" <%= getFieldValue('status') === 'published' ? 'selected' : '' %>>Published</option>
                                        <option value="archived" <%= getFieldValue('status') === 'archived' ? 'selected' : '' %>>Archived</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="nsfw" value="1" <%= getFieldValue('nsfw') ? 'checked' : '' %>>
                                    NSFW Content
                                </label>
                            </div>
                        </div>

                        <!-- Original Text -->
                        <div class="form-section">
                            <h3>Original Text</h3>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="original_language">Original Language</label>
                                    <select id="original_language" name="original_language">
                                        <option value="en" <%= getFieldValue('original_language') === 'en' ? 'selected' : '' %>>English</option>
                                        <option value="ja" <%= getFieldValue('original_language') === 'ja' ? 'selected' : '' %>>Japanese</option>
                                        <option value="zh" <%= getFieldValue('original_language') === 'zh' ? 'selected' : '' %>>Chinese</option>
                                        <option value="ko" <%= getFieldValue('original_language') === 'ko' ? 'selected' : '' %>>Korean</option>
                                        <option value="es" <%= getFieldValue('original_language') === 'es' ? 'selected' : '' %>>Spanish</option>
                                        <option value="fr" <%= getFieldValue('original_language') === 'fr' ? 'selected' : '' %>>French</option>
                                        <option value="de" <%= getFieldValue('original_language') === 'de' ? 'selected' : '' %>>German</option>
                                        <option value="ru" <%= getFieldValue('original_language') === 'ru' ? 'selected' : '' %>>Russian</option>
                                        <option value="pt" <%= getFieldValue('original_language') === 'pt' ? 'selected' : '' %>>Portuguese</option>
                                        <option value="it" <%= getFieldValue('original_language') === 'it' ? 'selected' : '' %>>Italian</option>
                                        <option value="other" <%= getFieldValue('original_language') === 'other' ? 'selected' : '' %>>Other</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="original_title">Original Title</label>
                                    <input type="text" id="original_title" name="original_title" value="<%= getFieldValue('original_title') %>">
                                    <small>Leave blank to use main title</small>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="original_content">Original Content *</label>
                                <textarea id="original_content" name="original_content" rows="15" required><%= getFieldValue('original_content') %></textarea>
                                <small id="original_word_count">0 words</small>
                            </div>
                        </div>

                        <!-- Translation -->
                        <div class="form-section">
                            <h3>Translation</h3>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="translated_language">Translated Language</label>
                                    <select id="translated_language" name="translated_language">
                                        <option value="">No translation</option>
                                        <option value="en" <%= getFieldValue('translated_language') === 'en' ? 'selected' : '' %>>English</option>
                                        <option value="ja" <%= getFieldValue('translated_language') === 'ja' ? 'selected' : '' %>>Japanese</option>
                                        <option value="zh" <%= getFieldValue('translated_language') === 'zh' ? 'selected' : '' %>>Chinese</option>
                                        <option value="ko" <%= getFieldValue('translated_language') === 'ko' ? 'selected' : '' %>>Korean</option>
                                        <option value="es" <%= getFieldValue('translated_language') === 'es' ? 'selected' : '' %>>Spanish</option>
                                        <option value="fr" <%= getFieldValue('translated_language') === 'fr' ? 'selected' : '' %>>French</option>
                                        <option value="de" <%= getFieldValue('translated_language') === 'de' ? 'selected' : '' %>>German</option>
                                        <option value="ru" <%= getFieldValue('translated_language') === 'ru' ? 'selected' : '' %>>Russian</option>
                                        <option value="pt" <%= getFieldValue('translated_language') === 'pt' ? 'selected' : '' %>>Portuguese</option>
                                        <option value="it" <%= getFieldValue('translated_language') === 'it' ? 'selected' : '' %>>Italian</option>
                                        <option value="other" <%= getFieldValue('translated_language') === 'other' ? 'selected' : '' %>>Other</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="translated_title">Translated Title</label>
                                    <input type="text" id="translated_title" name="translated_title" value="<%= getFieldValue('translated_title') %>">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="translated_content">Translated Content</label>
                                <textarea id="translated_content" name="translated_content" rows="15"><%= getFieldValue('translated_content') %></textarea>
                                <small id="translated_word_count">0 words</small>
                            </div>
                        </div>

                        <!-- Relationships -->
                        <div class="form-section">
                            <h3>Relationships</h3>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="artist_id">Artist</label>
                                    <div data-autocomplete="artist" data-placeholder="Start typing to search for an artist..." class="artist-autocomplete">
                                        <select id="artist_id" name="artist_id" style="display: none;">
                                            <option value="">Select an artist</option>
                                            <% artists.forEach(artist => { %>
                                                <option value="<%= artist.id %>" <%= getFieldValue('artist_id') == artist.id ? 'selected' : '' %>>
                                                    <%= artist.name %>
                                                </option>
                                            <% }); %>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="collection_id">Collection</label>
                                    <select id="collection_id" name="collection_id">
                                        <option value="">No collection</option>
                                        <% collections.forEach(collection => { %>
                                            <option value="<%= collection.id %>" <%= getFieldValue('collection_id') == collection.id ? 'selected' : '' %>>
                                                <%= collection.name %>
                                            </option>
                                        <% }); %>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="tag_names">Tags</label>
                                <input type="text" id="tag_names" name="tag_names" value="<%= getFieldValue('tag_names') %>" placeholder="Tag 1, Tag 2, Tag 3">
                                <small>Separate multiple tags with commas</small>
                            </div>

                            <div class="form-group">
                                <label for="character_ids">Characters</label>
                                <div data-autocomplete="character" data-multiple data-placeholder="Start typing to search for characters..." class="character-autocomplete">
                                    <div style="display: none;">
                                        <% characters.forEach(character => { %>
                                            <input type="checkbox" name="character_ids" value="<%= character.id %>" 
                                                <%= (novel && novel.character_ids && novel.character_ids.includes(character.id)) ? 'checked' : '' %>>
                                        <% }); %>
                                    </div>
                                </div>
                                <small class="form-help">Start typing to search and select multiple characters</small>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-solid">
                            <%= novel ? 'Update' : 'Create' %> Novel
                        </button>
                        <a href="/admin/novels" class="btn btn-ghost">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script src="/public/js/app.js"></script>
    <script src="/public/js/admin.js"></script>
    <script src="/public/js/autocomplete.js"></script>
    <script>
        // Word count functionality
        function countWords(text) {
            return text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
        }

        function updateWordCount(textareaId, counterId) {
            const textarea = document.getElementById(textareaId);
            const counter = document.getElementById(counterId);
            
            if (textarea && counter) {
                const wordCount = countWords(textarea.value);
                counter.textContent = wordCount.toLocaleString() + ' words';
            }
        }

        // Initialize word counts
        document.addEventListener('DOMContentLoaded', function() {
            updateWordCount('original_content', 'original_word_count');
            updateWordCount('translated_content', 'translated_word_count');

            // Add event listeners for real-time updates
            document.getElementById('original_content').addEventListener('input', function() {
                updateWordCount('original_content', 'original_word_count');
            });

            document.getElementById('translated_content').addEventListener('input', function() {
                updateWordCount('translated_content', 'translated_word_count');
            });
        });
    </script>

    <style>
        .novel-form {
            max-width: 1000px;
            margin: 0 auto;
        }

        .form-grid {
            display: grid;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .form-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: var(--shadow);
        }

        .form-section h3 {
            margin: 0 0 1.5rem 0;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            font-family: ui-monospace, 'SF Mono', 'Monaco', 'Consolas', 'Liberation Mono', 'Menlo', monospace;
            line-height: 1.5;
        }

        .form-group small {
            display: block;
            margin-top: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: normal;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }

        .checkbox-label input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .character-select {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            background: var(--input-bg);
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-start;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .alert-error {
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
        }

        .dark-theme .alert-error {
            background-color: #450a0a;
            border: 1px solid #dc2626;
            color: #fca5a5;
        }
    </style>
</body>
</html>