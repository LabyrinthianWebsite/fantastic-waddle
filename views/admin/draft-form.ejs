<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= draft ? 'Edit' : 'Add' %> Draft - Admin - CommissionDB</title>
    <link rel="stylesheet" href="/public/css/style.css">
    <link rel="stylesheet" href="/public/css/admin.css">
</head>
<body class="dark-theme">
    <nav class="admin-navbar">
        <div class="admin-navbar-container">
            <div class="admin-navbar-brand">
                <a href="/admin">CommissionDB Admin</a>
            </div>
            
            <div class="admin-navbar-menu">
                <a href="/admin" class="admin-navbar-item">Dashboard</a>
                <a href="/admin/commissions" class="admin-navbar-item">Commissions</a>
                <a href="/admin/drafts" class="admin-navbar-item active">Drafts</a>
                <a href="/admin/characters" class="admin-navbar-item">Characters</a>
                <a href="/admin/upper-campus" class="admin-navbar-item">Upper Campus</a>
                <a href="/admin/artists" class="admin-navbar-item">Artists</a>
                <a href="/admin/collections" class="admin-navbar-item">Collections</a>
                <a href="/admin/tags" class="admin-navbar-item">Tags</a>
                <form action="/admin/logout" method="POST" style="display: inline;">
                    <button type="submit" class="admin-navbar-item admin-logout">Logout</button>
                </form>
            </div>
        </div>
    </nav>

    <main class="admin-main">
        <div class="admin-container">
            <div class="admin-header">
                <h1><%= draft ? 'Edit' : 'Add' %> Draft</h1>
            </div>

            <div class="admin-content">
                <% if (error) { %>
                    <div class="error-message">
                        <%= error %>
                    </div>
                <% } %>

                <%
                function getFieldValue(fieldName) {
                    if (typeof formData !== 'undefined' && formData && formData[fieldName] !== undefined) {
                        return formData[fieldName];
                    }
                    if (draft && draft[fieldName] !== undefined) {
                        return draft[fieldName];
                    }
                    return '';
                }
                %>

                <form method="POST" action="<%= draft ? `/admin/drafts/${draft.id}/edit` : '/admin/drafts/new' %>" enctype="multipart/form-data" class="form">
                    
                    <!-- Basic Information -->
                    <div class="form-section">
                        <h3>Basic Information</h3>
                        
                        <div class="form-group">
                            <label for="title">Title *</label>
                            <input type="text" id="title" name="title" value="<%= getFieldValue('title') %>" required>
                        </div>

                        <div class="form-group">
                            <label for="description">Description</label>
                            <textarea id="description" name="description" rows="4"><%= getFieldValue('description') %></textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="status">Status</label>
                                <select id="status" name="status">
                                    <option value="requested" <%= getFieldValue('status') === 'requested' ? 'selected' : '' %>>Requested</option>
                                    <option value="accepted" <%= getFieldValue('status') === 'accepted' ? 'selected' : '' %>>Accepted</option>
                                    <option value="in_progress" <%= getFieldValue('status') === 'in_progress' ? 'selected' : '' %>>In Progress</option>
                                    <option value="completed" <%= getFieldValue('status') === 'completed' ? 'selected' : '' %>>Completed</option>
                                    <option value="delivered" <%= getFieldValue('status') === 'delivered' ? 'selected' : '' %>>Delivered</option>
                                    <option value="canceled" <%= getFieldValue('status') === 'canceled' ? 'selected' : '' %>>Canceled</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="date_month">Date Started (YYYY-MM)</label>
                                <input type="text" id="date_month" name="date_month" value="<%= getFieldValue('date_month') %>" placeholder="2024-01">
                            </div>

                            <div class="form-group">
                                <label for="price">Price ($)</label>
                                <input type="number" id="price" name="price" step="0.01" value="<%= getFieldValue('price') %>">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="client_name">Client Name</label>
                                <input type="text" id="client_name" name="client_name" value="<%= getFieldValue('client_name') %>">
                            </div>

                            <div class="form-group">
                                <label for="deadline_date">Deadline</label>
                                <input type="date" id="deadline_date" name="deadline_date" value="<%= getFieldValue('deadline_date') %>">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="notes">Internal Notes</label>
                            <textarea id="notes" name="notes" rows="3" placeholder="Internal notes about progress, requirements, etc."><%= getFieldValue('notes') %></textarea>
                        </div>
                    </div>

                    <!-- Associations -->
                    <div class="form-section">
                        <h3>Associations</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="artist_id">Artist</label>
                                <div data-autocomplete="artist" data-placeholder="Start typing to search for an artist..." class="artist-autocomplete">
                                    <select id="artist_id" name="artist_id" style="display: none;">
                                        <option value="">Select an artist...</option>
                                        <% artists.forEach(artist => { %>
                                            <option value="<%= artist.id %>" <%= getFieldValue('artist_id') == artist.id ? 'selected' : '' %>><%= artist.name %></option>
                                        <% }) %>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="collection_id">Collection</label>
                                <select id="collection_id" name="collection_id">
                                    <option value="">Select a collection...</option>
                                    <% collections.forEach(collection => { %>
                                        <option value="<%= collection.id %>" <%= getFieldValue('collection_id') == collection.id ? 'selected' : '' %>><%= collection.name %></option>
                                    <% }) %>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="character_ids">Characters</label>
                            <div data-autocomplete="character" data-multiple data-placeholder="Start typing to search for characters..." class="character-autocomplete">
                                <select id="character_ids" name="character_ids" multiple style="display: none;">
                                    <% characters.forEach(character => { %>
                                        <% 
                                        const selectedCharacterIds = draft && draft.character_ids ? draft.character_ids : [];
                                        const isSelected = selectedCharacterIds.includes(character.id);
                                        %>
                                        <option value="<%= character.id %>" <%= isSelected ? 'selected' : '' %>><%= character.name %></option>
                                    <% }) %>
                                </select>
                            </div>
                            <small class="form-help">Start typing to search and select multiple characters</small>
                        </div>

                        <div class="form-group">
                            <label for="tag_names">Tags</label>
                            <input type="text" id="tag_names" name="tag_names" value="<%= getFieldValue('tag_names') %>" placeholder="tag1, tag2, tag3">
                            <small class="form-help">Comma-separated tag names</small>
                        </div>
                    </div>

                    <!-- Images -->
                    <div class="form-section">
                        <h3>Draft Images</h3>
                        
                        <!-- Draft Images Manager -->
                        <%- include('partials/image-manager', {
                            title: 'Draft Images',
                            images: draft ? draft.existing_draft_images : [],
                            imageType: 'draft',
                            commission: draft,
                            showUpload: true
                        }) %>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-solid">
                            <%= draft ? 'Update' : 'Create' %> Draft
                        </button>
                        <a href="/admin/drafts" class="btn btn-ghost">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <style>
    .form {
        max-width: 800px;
    }

    .form-section {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow);
    }

    .form-section h3 {
        margin: 0 0 1rem 0;
        color: var(--text);
        font-size: 1.125rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text);
        font-weight: 500;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 1rem;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: var(--input-bg);
        color: var(--text);
        font-size: 1rem;
        line-height: 1.5;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
    }

    .form-help {
        display: block;
        margin-top: 0.25rem;
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .form-actions {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }

    .error-message {
        background: #dc2626;
        color: white;
        padding: 1rem;
        border-radius: 0.375rem;
        margin-bottom: 1rem;
    }
    </style>

    <script src="/public/js/app.js"></script>
    <script src="/public/js/admin.js"></script>
    <script src="/public/js/autocomplete.js"></script>
</body>
</html>