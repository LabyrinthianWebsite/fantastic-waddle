<%# Image Manager Partial %>
<%# Parameters: %>
<%#   - title: Display title for the manager %>
<%#   - images: Array of existing images %>
<%#   - imageType: Type of images ('gallery', 'draft', 'files') %>
<%#   - commission: Commission or draft object (for API calls) %>
<%#   - showUpload: Whether to show the upload area (default: true) %>

<% 
const shouldShowUpload = typeof showUpload !== 'undefined' ? showUpload : true; 
const imageArray = images || [];
const itemObject = commission; // Can be commission or draft object
%>

<div class="form-group">
    <label for="<%= imageType %>_images"><%= title %></label>
    
    <% if (shouldShowUpload) { %>
        <div class="enhanced-upload-zone" data-image-type="<%= imageType %>">
            <input type="file" 
                   id="<%= imageType %>_images" 
                   name="<%= imageType === 'files' ? 'files' : imageType + '_images' %>" 
                   accept="<%= imageType === 'files' ? '*' : 'image/*' %>" 
                   multiple
                   style="display: none;">
            
            <div class="upload-drop-area" data-for="<%= imageType %>_images">
                <div class="upload-icon">
                    <% if (imageType === 'files') { %>
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14,2 14,8 20,8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                            <polyline points="10,9 9,9 8,9"/>
                        </svg>
                    <% } else { %>
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <polyline points="21,15 16,10 5,21"/>
                        </svg>
                    <% } %>
                </div>
                
                <div class="upload-text">
                    <h4>Drop <%= imageType === 'files' ? 'files' : 'images' %> here or click to browse</h4>
                    <p>
                        <%= imageType === 'files' ? 
                            'Upload PSD, documents, and other files' : 
                            imageType === 'draft' ? 
                                'Upload work-in-progress or draft images' : 
                                'Upload finished images for the gallery' 
                        %>
                    </p>
                    <p class="upload-formats">
                        <%= imageType === 'files' ? 
                            'Supports: PSD, PDF, ZIP, RAR, TXT, DOC, and more' : 
                            'Supports: JPG, PNG, GIF, WEBP' 
                        %>
                    </p>
                </div>
                
                <button type="button" class="upload-browse-btn">Choose Files</button>
            </div>
            
            <!-- Image Preview Container -->
            <div class="upload-preview-container" style="display: none;">
                <div class="upload-preview-header">
                    <h4>Selected Files (<span class="preview-count">0</span>)</h4>
                    <button type="button" class="clear-selection-btn">Clear All</button>
                </div>
                <div class="upload-preview-grid">
                    <!-- Preview items will be added here dynamically -->
                </div>
                <div class="upload-actions">
                    <button type="button" class="add-more-btn">Add More Files</button>
                    <div class="upload-validation-info">
                        <span class="validation-status"></span>
                    </div>
                </div>
            </div>
        </div>
    <% } %>
    
    <% if (itemObject && imageArray.length > 0) { %>
        <div class="image-manager" 
             data-commission-id="<%= itemObject.id %>" 
             data-image-type="<%= imageType %>">
            
            <div class="image-manager-header">
                <h4 class="image-manager-title">Current <%= title %></h4>
                <span class="image-manager-count"><%= imageArray.length %> item<%= imageArray.length !== 1 ? 's' : '' %></span>
            </div>
            
            <% if (imageType === 'files') { %>
                <!-- File list view for non-images -->
                <div class="file-list">
                    <% imageArray.forEach((file, index) => { %>
                        <div class="file-item" 
                             data-image-id="<%= file.id %>" 
                             data-file-name="<%= file.filename %>">
                            
                            <div class="file-icon">
                                <%= file.mime_type && file.mime_type.startsWith('image/') ? '🖼️' : 
                                    file.filename.endsWith('.pdf') ? '📄' : 
                                    file.filename.endsWith('.zip') || file.filename.endsWith('.rar') ? '📦' : 
                                    file.filename.endsWith('.psd') ? '🎨' : '📎' %>
                            </div>
                            
                            <div class="file-info">
                                <div class="file-name"><%= file.original_filename %></div>
                                <div class="file-meta">
                                    <%= file.filesize ? (file.filesize / 1024 / 1024).toFixed(2) + ' MB' : '' %>
                                    <% if (file.mime_type) { %> • <%= file.mime_type %><% } %>
                                </div>
                            </div>
                            
                            <div class="file-actions">
                                <% if (file.file_path) { %>
                                    <a href="/uploads/<%= file.file_path %>" 
                                       target="_blank" 
                                       class="image-action-btn" 
                                       title="Download">⬇</a>
                                <% } %>
                                <button type="button" 
                                        class="image-action-btn delete delete-btn" 
                                        title="Delete">🗑</button>
                            </div>
                        </div>
                    <% }); %>
                </div>
            <% } else { %>
                <!-- Enhanced slideshow view for images -->
                <div class="image-slideshow-container">
                    <!-- Main slideshow area -->
                    <div class="slideshow-main">
                        <div class="slideshow-viewer">
                            <% if (imageArray.length > 0) { %>
                                <div class="slideshow-image-container">
                                    <img src="/uploads/<%= imageArray[0].display_path || imageArray[0].thumb_path %>" 
                                         alt="<%= imageArray[0].filename %>" 
                                         class="slideshow-main-image" 
                                         data-image-index="0">
                                </div>
                                
                                <!-- Navigation controls -->
                                <% if (imageArray.length > 1) { %>
                                    <button class="slideshow-nav slideshow-prev" type="button" title="Previous image">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="m15 18-6-6 6-6"/>
                                        </svg>
                                    </button>
                                    <button class="slideshow-nav slideshow-next" type="button" title="Next image">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="m9 18 6-6-6-6"/>
                                        </svg>
                                    </button>
                                <% } %>
                                
                                <!-- Image counter -->
                                <div class="slideshow-counter">
                                    <span class="current-slide">1</span> / <span class="total-slides"><%= imageArray.length %></span>
                                </div>
                                
                                <!-- Action buttons overlay -->
                                <div class="slideshow-actions">
                                    <button type="button" 
                                            class="slideshow-action-btn preview-btn" 
                                            title="Preview Full Size">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                            <circle cx="12" cy="12" r="3"/>
                                        </svg>
                                    </button>
                                    <a href="/uploads/<%= imageArray[0].original_path || imageArray[0].display_path %>" 
                                       target="_blank" 
                                       class="slideshow-action-btn download-btn" 
                                       title="View Original">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                            <polyline points="7,10 12,15 17,10"/>
                                            <line x1="12" y1="15" x2="12" y2="3"/>
                                        </svg>
                                    </a>
                                    <button type="button" 
                                            class="slideshow-action-btn delete-btn" 
                                            title="Delete Image">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M3 6h18"/>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                            <line x1="10" y1="11" x2="10" y2="17"/>
                                            <line x1="14" y1="11" x2="14" y2="17"/>
                                        </svg>
                                    </button>
                                </div>
                            <% } %>
                        </div>
                    </div>
                    
                    <!-- Thumbnail strip for navigation and reordering -->
                    <div class="slideshow-thumbnails">
                        <div class="thumbnail-strip" data-image-type="<%= imageType %>">
                            <% imageArray.forEach((image, index) => { %>
                                <div class="thumbnail-item" 
                                     data-image-id="<%= image.id %>" 
                                     data-image-index="<%= index %>"
                                     data-image-path="<%= image.thumb_path || image.display_path %>"
                                     data-display-path="<%= image.display_path || image.thumb_path %>"
                                     data-original-path="<%= image.original_path || '' %>"
                                     data-file-name="<%= image.filename %>">
                                    
                                    <div class="thumbnail-image-wrapper">
                                        <img src="/uploads/<%= image.thumb_path || image.display_path %>" 
                                             alt="<%= image.filename %>" 
                                             class="thumbnail-image"
                                             loading="lazy">
                                        <div class="thumbnail-order-badge"><%= index + 1 %></div>
                                    </div>
                                    
                                    <div class="thumbnail-overlay">
                                        <div class="thumbnail-actions">
                                            <span class="drag-handle" title="Drag to reorder">⋮⋮</span>
                                            <button type="button" 
                                                    class="thumbnail-delete-btn delete-btn" 
                                                    title="Delete">×</button>
                                        </div>
                                    </div>
                                </div>
                            <% }); %>
                        </div>
                    </div>
                </div>
                
                <!-- Hidden data for JavaScript -->
                <div class="slideshow-data" style="display: none;">
                    <% imageArray.forEach((image, index) => { %>
                        <div data-index="<%= index %>"
                             data-image-id="<%= image.id %>"
                             data-thumb="<%= image.thumb_path || image.display_path %>"
                             data-display="<%= image.display_path || image.thumb_path %>"
                             data-original="<%= image.original_path || '' %>"
                             data-filename="<%= image.filename %>"></div>
                    <% }); %>
                </div>
            <% } %>
        </div>
    <% } else if (itemObject) { %>
        <div class="empty-state">
            <p>No <%= title.toLowerCase() %> uploaded yet.</p>
        </div>
    <% } %>
</div>