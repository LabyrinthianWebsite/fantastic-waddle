<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= character.name %> - CommissionDB</title>
    <link rel="stylesheet" href="/public/css/style.css">
    <link rel="icon" type="image/x-icon" href="/public/icons/favicon.ico">
</head>
<body class="dark-theme">
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">
                <a href="/">CommissionDB</a>
            </div>
            
            <div class="navbar-menu">
                <a href="/" class="navbar-item">Browse</a>
                <a href="/characters" class="navbar-item">Characters</a>
                <a href="/upper-campus" class="navbar-item">Upper Campus</a>
                <a href="/artists" class="navbar-item">Artists</a>
                <a href="/collections" class="navbar-item">Collections</a>
                <a href="/tags" class="navbar-item">Tags</a>
                <a href="/stats" class="navbar-item">Stats</a>
            </div>

            <div class="navbar-end">
                <div class="navbar-item">
                    <button class="btn btn-ghost" id="theme-toggle" aria-label="Toggle theme">
                        <span class="theme-icon">ðŸŒ™</span>
                    </button>
                </div>
                
                <div class="navbar-item">
                    <button class="btn btn-ghost" id="safe-mode-toggle" aria-label="Toggle safe mode">
                        <span class="safe-mode-icon">ðŸ”’</span>
                    </button>
                </div>

                <div class="navbar-item">
                    <a href="/admin" class="btn btn-solid">Admin</a>
                </div>

                <div class="navbar-item">
                    <button class="btn btn-ghost" id="keyboard-help" aria-label="Keyboard shortcuts">
                        <span>?</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="main-content">

<div class="character-detail-container">
    <!-- Character Header -->
    <div class="character-header">
        <div class="character-portrait-large">
            <img 
                src="<%= character.portrait_url %>" 
                alt="<%= character.name %>"
                class="character-image-large"
            >
        </div>
        
        <div class="character-info-main">
            <h1 class="character-name-large"><%= character.name %></h1>
            
            <div class="character-attributes">
                <% if (character.universe) { %>
                    <div class="attribute">
                        <span class="attribute-label">Universe:</span>
                        <span class="attribute-value"><%= character.universe %></span>
                    </div>
                <% } %>
                
                <% if (character.role) { %>
                    <div class="attribute">
                        <span class="attribute-label">Role:</span>
                        <span class="attribute-value"><%= character.role %></span>
                    </div>
                <% } %>
                
                <% if (character.dormitory) { %>
                    <div class="attribute">
                        <span class="attribute-label">Dormitory:</span>
                        <span 
                            class="attribute-value dormitory-name" 
                            style="color: <%= character.dormitory_color %>"
                        >
                            <%= character.dormitory %>
                            <% if (character.dormitory_animal) { %>
                                <sup class="dormitory-icon" title="<%= character.dormitory %>"><%= character.dormitory_animal %></sup>
                            <% } %>
                        </span>
                    </div>
                <% } %>
                
                <% if (character.year_level) { %>
                    <div class="attribute">
                        <span class="attribute-label">Year Level:</span>
                        <span class="attribute-value"><%= character.year_level %></span>
                    </div>
                <% } %>
                
                <% if (character.age_category) { %>
                    <div class="attribute">
                        <span class="attribute-label">Age Category:</span>
                        <span class="attribute-value"><%= character.age_category %></span>
                    </div>
                <% } %>
                
                <% if (character.hair_color) { %>
                    <div class="attribute">
                        <span class="attribute-label">Hair Color:</span>
                        <span class="attribute-value"><%= character.hair_color %></span>
                    </div>
                <% } %>
                
                <% if (character.eye_color) { %>
                    <div class="attribute">
                        <span class="attribute-label">Eye Color:</span>
                        <span class="attribute-value"><%= character.eye_color %></span>
                    </div>
                <% } %>
            </div>
            
            <% if (character.description) { %>
                <div class="character-description">
                    <p><%= character.description %></p>
                </div>
            <% } %>
            
            <div class="character-links">
                <% if (character.wiki_page) { %>
                    <a href="<%= character.wiki_page %>" target="_blank" class="btn btn-ghost">
                        ðŸ“– Wiki Page
                    </a>
                <% } %>
                <% if (character.external_profile_url) { %>
                    <a href="<%= character.external_profile_url %>" target="_blank" class="btn btn-ghost">
                        ðŸ”— External Profile
                    </a>
                <% } %>
            </div>
        </div>
    </div>

    <div class="character-content">
        <!-- Character Versions Timeline -->
        <% if (versions && versions.length > 0) { %>
        <section class="character-section">
            <h2>Character Versions Timeline</h2>
            <div class="timeline-container">
                <div id="character-timeline" class="timeline-visualization"></div>
            </div>
        </section>
        <% } %>

        <!-- Relationship Graph -->
        <% if (coAppearances && coAppearances.length > 0) { %>
        <section class="character-section">
            <h2>Character Relationships</h2>
            <p>Characters that appear together with <%= character.name %> in commissions</p>
            <div class="relationships-container">
                <div id="relationship-graph" class="relationship-visualization"></div>
            </div>
        </section>
        <% } %>

        <!-- Commission Timeline -->
        <% if (timeline && Object.keys(timeline).length > 0) { %>
        <section class="character-section">
            <h2>Commission Activity Timeline</h2>
            <div class="commission-timeline-container">
                <div id="commission-timeline" class="commission-timeline-visualization"></div>
            </div>
        </section>
        <% } %>

        <!-- Recent Commissions -->
        <% if (commissions && commissions.length > 0) { %>
        <section class="character-section">
            <h2>Featured In Commissions (<%= commissions.length %>)</h2>
            <div class="commissions-grid">
                <% commissions.slice(0, 12).forEach(commission => { %>
                    <div class="commission-card small">
                        <a href="/c/<%= commission.slug %>" class="commission-link">
                            <div class="commission-image">
                                <img 
                                    src="<%= commission.thumb_url %>" 
                                    alt="<%= commission.title %>"
                                    class="commission-thumb"
                                    loading="lazy"
                                >
                            </div>
                            <div class="commission-info">
                                <h4 class="commission-title"><%= commission.title %></h4>
                                <div class="commission-meta">
                                    <span class="commission-date"><%= commission.formatted_date %></span>
                                    <% if (commission.artist_name) { %>
                                        <span class="commission-artist">by <%= commission.artist_name %></span>
                                    <% } %>
                                </div>
                            </div>
                        </a>
                    </div>
                <% }) %>
            </div>
            
            <% if (commissions.length > 12) { %>
                <div class="view-all-link">
                    <a href="/?character_ids[]=<%= character.id %>" class="btn btn-solid">
                        View All <%= commissions.length %> Commissions
                    </a>
                </div>
            <% } %>
        </section>
        <% } %>

        <!-- Related Characters -->
        <% if (relationships && relationships.length > 0) { %>
        <section class="character-section">
            <h2>Character Relationships</h2>
            <div class="relationships-list">
                <% relationships.forEach(rel => { %>
                    <div class="relationship-item">
                        <a href="/char/<%= rel.related_character_slug %>" class="relationship-link">
                            <div class="relationship-info">
                                <span class="relationship-character"><%= rel.related_character_name %></span>
                                <span class="relationship-type"><%= rel.relationship_type %></span>
                                <% if (rel.description) { %>
                                    <span class="relationship-description"><%= rel.description %></span>
                                <% } %>
                            </div>
                        </a>
                    </div>
                <% }) %>
            </div>
        </section>
        <% } %>
        
        <!-- MediaWiki Database Embed -->
        <% if (character.wiki_page || character.name) { %>
        <section class="character-section">
            <h2>Database Information</h2>
            <div class="mediawiki-embed-container">
                <iframe 
                    src="http://localhost/database/index.php/<%= character.wiki_page || character.name.replace(/\s+/g, '_') %>" 
                    class="mediawiki-embed"
                    title="Character database information for <%= character.name %>"
                    frameborder="0"
                    scrolling="auto"
                ></iframe>
            </div>
        </section>
        <% } %>
    </div>
</div>

<style>
.character-detail-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
}

.character-header {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 2rem;
    margin-bottom: 3rem;
    background: var(--card-bg);
    border-radius: 12px;
    padding: 2rem;
    box-shadow: var(--shadow);
}

.character-portrait-large {
    max-width: 300px;
    border-radius: 8px;
    overflow: hidden;
    background: var(--bg-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
}

.character-image-large {
    width: 100%;
    height: auto;
    max-height: 400px;
    object-fit: contain;
    object-position: center;
}

.character-name-large {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    color: var(--text);
}

.character-attributes {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.attribute {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.attribute-label {
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.attribute-value {
    color: var(--text);
    font-size: 1.1rem;
}

.dormitory-name {
    font-weight: 600;
}

.character-description {
    margin-bottom: 1.5rem;
    color: var(--text);
    line-height: 1.6;
}

.character-links {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.character-section {
    margin-bottom: 3rem;
}

.character-section h2 {
    font-size: 1.8rem;
    margin-bottom: 1rem;
    color: var(--text);
    border-bottom: 2px solid var(--primary);
    padding-bottom: 0.5rem;
}

.timeline-container,
.relationships-container,
.commission-timeline-container {
    background: var(--card-bg);
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: var(--shadow);
}

.timeline-visualization,
.relationship-visualization,
.commission-timeline-visualization {
    min-height: 400px;
    border-radius: 4px;
    background: var(--bg);
    border: 1px solid var(--border);
}

.commissions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 1rem;
}

.commission-card.small {
    background: var(--card-bg);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: var(--shadow);
    transition: transform 0.2s ease;
}

.commission-card.small:hover {
    transform: translateY(-2px);
}

.commission-card.small .commission-image {
    aspect-ratio: 4/3;
    overflow: hidden;
}

.commission-card.small .commission-thumb {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.commission-card.small .commission-info {
    padding: 1rem;
}

.commission-card.small .commission-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text);
}

.commission-card.small .commission-meta {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.relationships-list {
    display: grid;
    gap: 1rem;
}

.relationship-item {
    background: var(--card-bg);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: var(--shadow);
}

.relationship-link {
    display: block;
    padding: 1rem;
    text-decoration: none;
    color: inherit;
    transition: background-color 0.2s ease;
}

.relationship-link:hover {
    background-color: var(--bg-secondary);
}

.relationship-info {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.relationship-character {
    font-weight: 600;
    color: var(--text);
    font-size: 1.1rem;
}

.relationship-type {
    color: var(--primary);
    font-weight: 500;
    text-transform: capitalize;
}

.relationship-description {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.view-all-link {
    text-align: center;
    margin-top: 2rem;
}

.btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    transition: all 0.2s ease;
    font-weight: 500;
}

.btn-solid {
    background: var(--primary);
    color: white;
}

.btn-ghost {
    background: transparent;
    color: var(--text-secondary);
    border: 1px solid var(--border);
}

.btn:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}

@media (max-width: 768px) {
    .character-header {
        grid-template-columns: 1fr;
        text-align: center;
    }
    
    .character-portrait-large {
        max-width: 300px;
        margin: 0 auto;
    }
    
    .character-name-large {
        font-size: 2rem;
    }
    
    .commissions-grid {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    }
}

/* MediaWiki Embed Styles */
.mediawiki-embed-container {
    background: var(--card-bg);
    border-radius: 8px;
    padding: 1rem;
    box-shadow: var(--shadow);
    overflow: hidden;
}

.mediawiki-embed {
    width: 100%;
    height: 600px;
    min-height: 400px;
    border: none;
    border-radius: 4px;
    background: #fff;
}

@media (max-width: 768px) {
    .mediawiki-embed {
        height: 400px;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize visualizations if data is available
    
    // Character Timeline Visualization
    <% if (versions && versions.length > 0) { %>
    initCharacterTimeline();
    <% } %>
    
    // Relationship Graph Visualization  
    <% if (coAppearances && coAppearances.length > 0) { %>
    initRelationshipGraph();
    <% } %>
    
    // Commission Timeline Visualization
    <% if (timeline && Object.keys(timeline).length > 0) { %>
    initCommissionTimeline();
    <% } %>
});

function initCharacterTimeline() {
    const timelineData = <%- JSON.stringify(versions) %>;
    const container = document.getElementById('character-timeline');
    
    if (timelineData.length === 0) {
        container.innerHTML = '<p>No character versions available</p>';
        return;
    }
    
    // Simple timeline visualization
    container.innerHTML = timelineData.map((version, index) => `
        <div class="timeline-item" style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 4px;">
            <h4 style="margin: 0 0 0.5rem 0;">${version.version_name}</h4>
            ${version.date_period ? `<p style="margin: 0 0 0.5rem 0; color: var(--text-secondary);">${version.date_period}</p>` : ''}
            ${version.description ? `<p style="margin: 0; font-size: 0.9rem;">${version.description}</p>` : ''}
        </div>
    `).join('');
}

function initRelationshipGraph() {
    const relationshipData = <%- JSON.stringify(coAppearances) %>;
    const container = document.getElementById('relationship-graph');
    
    if (relationshipData.length === 0) {
        container.innerHTML = '<p>No character relationships found</p>';
        return;
    }
    
    // Simple network visualization
    const maxCount = Math.max(...relationshipData.map(r => r.count));
    
    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem;">
            ${relationshipData.map(char => `
                <div class="relationship-node" style="
                    padding: 1rem; 
                    background: var(--bg-secondary); 
                    border-radius: 8px; 
                    text-align: center;
                    border: 2px solid var(--primary);
                    opacity: ${0.5 + (char.count / maxCount) * 0.5};
                ">
                    <a href="/char/${char.slug}" style="text-decoration: none; color: inherit;">
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">${char.name}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">${char.count} commission${char.count !== 1 ? 's' : ''}</div>
                    </a>
                </div>
            `).join('')}
        </div>
    `;
}

function initCommissionTimeline() {
    const timelineData = <%- JSON.stringify(timeline) %>;
    const container = document.getElementById('commission-timeline');
    
    const months = Object.keys(timelineData).sort();
    if (months.length === 0) {
        container.innerHTML = '<p>No commission timeline data available</p>';
        return;
    }
    
    const maxCount = Math.max(...Object.values(timelineData).map(month => month.count));
    
    container.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
            ${months.map(month => {
                const data = timelineData[month];
                const width = (data.count / maxCount) * 100;
                return `
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="min-width: 120px; font-size: 0.9rem; color: var(--text-secondary);">
                            ${month}
                        </div>
                        <div style="flex: 1; background: var(--bg-secondary); border-radius: 4px; position: relative; height: 24px;">
                            <div style="
                                background: var(--primary); 
                                height: 100%; 
                                width: ${width}%; 
                                border-radius: 4px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: white;
                                font-size: 0.8rem;
                                font-weight: 600;
                            ">
                                ${data.count}
                            </div>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}
</script>

    <script src="/public/js/app.js"></script>
    </main>
</body>
</html>